{% extends "base.html" %}

{% block title %}Resume Detail{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 id="resume-title">Loading...</h2>
        <div style="display: flex; gap: 0.5rem;">
            <button onclick="deleteCurrentResume()" class="btn btn-danger">Delete Resume</button>
            <button class="btn btn-secondary" onclick="history.back()">← Back</button>
        </div>
    </div>
    
    <div id="resume-info"></div>
</div>

<div class="card">
    <h3>Evaluation Score</h3>
    <div id="overall-score" style="margin: 1rem 0;">
        <p style="color: #999;">Loading analysis<span class="spinner" style="border-color: #999; border-top-color: #333;"></span></p>
    </div>
    
    <h4 style="margin-top: 1.5rem;">Dimension Scores</h4>
    <div id="dimension-scores" style="margin-top: 1rem;"></div>
</div>

<div class="card">
    <h3>Recommendations</h3>
    <div id="recommendations">
        <p style="color: #999;">Loading recommendations<span class="spinner" style="border-color: #999; border-top-color: #333;"></span></p>
    </div>
</div>

<div class="card">
    <h3 class="collapsible collapsed">Extracted Resume Text</h3>
    <div class="collapse-content">
        <pre id="resume-text" style="white-space: pre-wrap; background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;"></pre>
    </div>
</div>

<div class="card">
    <h3 class="collapsible collapsed">Failed Checks</h3>
    <div class="collapse-content">
        <div id="failed-checks" style="margin-top: 1rem;"></div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    const resumeId = '{{ resume_id }}';
    
    async function loadResumeDetails() {
        try {
            const response = await fetch(`${API_BASE}/resumes/${resumeId}`, {
                headers: getAuthHeaders()
            });
            
            if (!response.ok) throw new Error('Failed to load resume');
            
            const resume = await response.json();
            
            document.getElementById('resume-title').textContent = `Resume: ${resume.version_label}`;
            document.getElementById('resume-info').innerHTML = `
                <p><strong>Uploaded:</strong> ${new Date(resume.uploaded_at).toLocaleString()}</p>
                <p><strong>Job ID:</strong> ${resume.job_id}</p>
            `;
            
            if (resume.extracted_text) {
                document.getElementById('resume-text').textContent = resume.extracted_text;
            }
        } catch (error) {
            console.error('Error loading resume:', error);
        }
    }
    
    async function loadEvaluation() {
        try {
            const response = await fetch(`${API_BASE}/resumes/${resumeId}/evaluation`, {
                headers: getAuthHeaders()
            });
            
            if (!response.ok) throw new Error('Failed to load evaluation');
            
            const evaluation = await response.json();
            
            // Overall score
            const scoreClass = evaluation.overall_score >= 4 ? '' : evaluation.overall_score >= 3 ? 'medium' : 'low';
            document.getElementById('overall-score').innerHTML = `
                <div style="font-size: 3rem; font-weight: bold;">
                    <span class="score ${scoreClass}">${evaluation.overall_score.toFixed(2)}</span>
                    <span style="font-size: 1.5rem; color: #999;"> / 5.00</span>
                </div>
            `;
            
            // Dimension scores
            const dimensions = Object.entries(evaluation.dimension_scores)
                .sort((a, b) => a[1].score - b[1].score); // Sort by score (lowest first)
            
            document.getElementById('dimension-scores').innerHTML = '<table><thead><tr><th>Dimension</th><th>Score</th><th>Weight</th><th>Issues</th></tr></thead><tbody>' +
                dimensions.map(([name, data]) => {
                    const scoreClass = data.score >= 4 ? '' : data.score >= 3 ? 'medium' : 'low';
                    return `
                        <tr>
                            <td><strong>${name}</strong></td>
                            <td><span class="score ${scoreClass}" style="font-size: 1.2rem;">${data.score.toFixed(1)}</span></td>
                            <td>${data.weight.toFixed(2)}</td>
                            <td>${data.failed_checks.length} issues</td>
                        </tr>
                    `;
                }).join('') +
                '</tbody></table>';
            
            // Recommendations
            const recs = evaluation.recommendations;
            let recsHtml = '';
            
            if (recs.top_priorities && recs.top_priorities.length > 0) {
                recsHtml += '<h4>Top Priorities</h4><ul>';
                recs.top_priorities.forEach(priority => {
                    recsHtml += `<li><strong>${priority.dimension}</strong> (Score: ${priority.score.toFixed(1)}): ${priority.advice}</li>`;
                });
                recsHtml += '</ul>';
            }
            
            if (recs.quick_wins && recs.quick_wins.length > 0) {
                recsHtml += '<h4 style="margin-top: 1.5rem;">Quick Wins</h4><ul>';
                recs.quick_wins.forEach(win => {
                    recsHtml += `<li>Bullet #${win.bullet_index}: ${win.issue}</li>`;
                });
                recsHtml += '</ul>';
            }
            
            if (recsHtml) {
                document.getElementById('recommendations').innerHTML = recsHtml;
            } else {
                document.getElementById('recommendations').innerHTML = '<p style="color: #999;">No specific recommendations.</p>';
            }
            
            // Failed checks
            const failedChecks = [];
            dimensions.forEach(([dimName, data]) => {
                data.failed_checks.forEach(check => {
                    failedChecks.push({...check, dimension: dimName});
                });
            });
            
            if (failedChecks.length > 0) {
                document.getElementById('failed-checks').innerHTML = '<table><thead><tr><th>Dimension</th><th>Signal</th><th>Issue</th><th>Context</th></tr></thead><tbody>' +
                    failedChecks.map(check => `
                        <tr>
                            <td>${check.dimension}</td>
                            <td><code>${check.signal}</code></td>
                            <td>${check.issue}</td>
                            <td><small>${check.context}</small></td>
                        </tr>
                    `).join('') +
                    '</tbody></table>';
            } else {
                document.getElementById('failed-checks').innerHTML = '<p style="color: #27ae60;">✓ All checks passed!</p>';
            }
            
        } catch (error) {
            console.error('Error loading evaluation:', error);
        }
    }
    
    async function deleteCurrentResume() {
        if (!confirm('Are you sure you want to delete this resume version?')) {
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE}/resumes/${resumeId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete resume');
            }
            
            // Go back to previous page (job detail)
            history.back();
        } catch (error) {
            console.error('Error deleting resume:', error);
            alert('Failed to delete resume. Please try again.');
        }
    }
    
    // Load all data
    loadResumeDetails();
    loadEvaluation();
</script>
{% endblock %}
