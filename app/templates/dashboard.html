{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Your Job Postings</h2>
        <button class="btn" onclick="showCreateJobModal()">+ New Job</button>
    </div>
    
    <div id="jobs-list" style="margin-top: 1.5rem;">
        <p style="color: #999;">Loading jobs...</p>
    </div>
</div>

<!-- Create Job Modal -->
<div id="create-job-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%;">
        <h2>Create New Job</h2>
        <form id="create-job-form" onsubmit="createJob(event)">
            <label for="job-title">Job Title</label>
            <input type="text" id="job-title" required>
            
            <label for="company-name">Company Name</label>
            <input type="text" id="company-name" required>
            
            <label for="job-posting">Job Posting Text</label>
            <textarea id="job-posting" required placeholder="Paste the full job posting here..."></textarea>
            
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn" id="create-job-btn">Create Job</button>
                <button type="button" class="btn btn-secondary" onclick="hideCreateJobModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    async function loadJobs() {
        try {
            const response = await fetch(`${API_BASE}/jobs`, {
                headers: getAuthHeaders()
            });
            
            if (!response.ok) {
                throw new Error('Failed to load jobs');
            }
            
            const jobs = await response.json();
            
            const jobsList = document.getElementById('jobs-list');
            
            if (jobs.length === 0) {
                jobsList.innerHTML = '<p style="color: #999;">No jobs yet. Create your first job to get started!</p>';
                return;
            }
            
            jobsList.innerHTML = '<table><thead><tr><th>Job Title</th><th>Company</th><th>Created</th><th>Actions</th></tr></thead><tbody>' +
                jobs.map(job => `
                    <tr id="job-row-${job.id}">
                        <td><a href="/jobs/${job.id}" style="color: #3498db; text-decoration: none;">${job.title}</a></td>
                        <td>${job.company_name}</td>
                        <td>${new Date(job.created_at).toLocaleDateString()}</td>
                        <td>
                            <a href="/jobs/${job.id}" class="btn" style="padding: 0.25rem 0.75rem; font-size: 0.9rem; line-height: 1.5; vertical-align: middle;">View</a>
                            <button onclick="deleteJob('${job.id}')" class="btn btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.9rem; margin-left: 0.5rem; line-height: 1.5; vertical-align: middle;">Delete</button>
                        </td>
                    </tr>
                `).join('') +
                '</tbody></table>';
        } catch (error) {
            console.error('Error loading jobs:', error);
            document.getElementById('jobs-list').innerHTML = `
                <div class="alert alert-warning">
                    Failed to load jobs. Please make sure you are authenticated.
                    <br><br>
                    For development: You need to set up Supabase authentication.
                </div>
            `;
        }
    }
    
    function showCreateJobModal() {
        document.getElementById('create-job-modal').style.display = 'block';
    }
    
    function hideCreateJobModal() {
        document.getElementById('create-job-modal').style.display = 'none';
        document.getElementById('create-job-form').reset();
    }
    
    async function createJob(event) {
        event.preventDefault();
        
        const btn = document.getElementById('create-job-btn');
        btn.classList.add('loading');
        btn.innerHTML = 'Creating Job<span class="spinner"></span>';
        
        const title = document.getElementById('job-title').value;
        const companyName = document.getElementById('company-name').value;
        const jobPosting = document.getElementById('job-posting').value;
        
        try {
            const response = await fetch(`${API_BASE}/jobs`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...getAuthHeaders()
                },
                body: JSON.stringify({
                    title: title,
                    company_name: companyName,
                    job_posting_text: jobPosting
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to create job');
            }
            
            const job = await response.json();
            
            hideCreateJobModal();
            window.location.href = `/jobs/${job.id}`;
        } catch (error) {
            console.error('Error creating job:', error);
            btn.classList.remove('loading');
            btn.innerHTML = 'Create Job';
            alert('Failed to create job. Please try again.');
        }
    }
    
    async function deleteJob(jobId) {
        if (!confirm('Are you sure you want to delete this job? This will also delete all associated resumes and evaluations.')) {
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE}/jobs/${jobId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete job');
            }
            
            // Remove row from table
            const row = document.getElementById(`job-row-${jobId}`);
            if (row) {
                row.remove();
            }
            
            // Check if no jobs left
            const tbody = document.querySelector('#jobs-list tbody');
            if (tbody && tbody.children.length === 0) {
                document.getElementById('jobs-list').innerHTML = '<p style="color: #999;">No jobs yet. Create your first job to get started!</p>';
            }
        } catch (error) {
            console.error('Error deleting job:', error);
            alert('Failed to delete job. Please try again.');
        }
    }
    
    // Load jobs on page load
    loadJobs();
</script>
{% endblock %}
