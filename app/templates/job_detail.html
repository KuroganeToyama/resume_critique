{% extends "base.html" %}

{% block title %}Job Detail{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 id="job-title">Loading...</h2>
        <div style="display: flex; gap: 0.5rem;">
            <button onclick="deleteCurrentJob()" class="btn btn-danger">Delete Job</button>
            <a href="/dashboard" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        </div>
    </div>
    
    <div id="job-content"></div>
</div>

<div class="card">
    <h3 class="collapsible collapsed">Job Posting Text</h3>
    <div class="collapse-content">
        <pre id="job-posting" style="white-space: pre-wrap; background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;"></pre>
    </div>
</div>

<div class="card">
    <h3 class="collapsible collapsed">Rubric Configuration</h3>
    <div class="collapse-content">
        <div id="rubric-content" style="margin-top: 1rem;"></div>
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>Resume Versions</h3>
        <button class="btn" onclick="showUploadModal()">+ Upload Resume</button>
    </div>
    
    <div id="resumes-list" style="margin-top: 1rem;"></div>
</div>

<div class="card">
    <h3>Progress Tracking</h3>
    <div id="progress-chart" style="margin-top: 1rem;"></div>
</div>

<!-- Upload Resume Modal -->
<div id="upload-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
        <h2>Upload Resume</h2>
        <form id="upload-form" onsubmit="uploadResume(event)">
            <label for="version-label">Version Label</label>
            <input type="text" id="version-label" required placeholder="e.g., v1, Draft 2, Final">
            
            <label for="resume-file">Resume File (PDF, DOCX, or TXT)</label>
            <input type="file" id="resume-file" accept=".pdf,.docx,.txt" required>
            
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="submit" class="btn" id="upload-resume-btn">Upload</button>
                <button type="button" class="btn btn-secondary" onclick="hideUploadModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    const jobId = '{{ job_id }}';
    
    // Reload page when accessed via back button to show updated data
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            window.location.reload();
        }
    });
    
    async function loadJobDetails() {
        try {
            const response = await fetch(`${API_BASE}/jobs/${jobId}`, {
                headers: getAuthHeaders()
            });
            
            if (!response.ok) throw new Error('Failed to load job');
            
            const job = await response.json();
            
            document.getElementById('job-title').textContent = `${job.title} at ${job.company_name}`;
            document.getElementById('job-posting').textContent = job.job_posting_text;
        } catch (error) {
            console.error('Error loading job:', error);
        }
    }
    
    async function loadRubric() {
        try {
            const response = await fetch(`${API_BASE}/jobs/${jobId}/rubric`, {
                headers: getAuthHeaders()
            });
            
            if (!response.ok) throw new Error('Failed to load rubric');
            
            const rubric = await response.json();
            
            const dimensions = Object.entries(rubric.dimension_overrides)
                .filter(([_, config]) => config.enabled)
                .sort((a, b) => b[1].weight - a[1].weight);
            
            document.getElementById('rubric-content').innerHTML = `
                <p><strong>Rubric Version:</strong> ${rubric.base_rubric_version}</p>
                <p><strong>Ruleset Version:</strong> ${rubric.ruleset_version}</p>
                <h4 style="margin-top: 1.5rem;">Enabled Dimensions (${dimensions.length})</h4>
                <div class="dimension-list">
                    ${dimensions.map(([name, config]) => `
                        <div class="dimension-card enabled">
                            <strong>${name}</strong><br>
                            <small>Weight: ${config.weight.toFixed(2)}</small><br>
                            <small>Category: ${config.category}</small>
                            ${config.relevant_tags && config.relevant_tags.length > 0 ? `<br><small>Tags: ${config.relevant_tags.join(', ')}</small>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        } catch (error) {
            console.error('Error loading rubric:', error);
        }
    }
    
    async function loadResumes() {
        try {
            const response = await fetch(`${API_BASE}/jobs/${jobId}/resumes`, {
                headers: getAuthHeaders()
            });
            
            if (!response.ok) throw new Error('Failed to load resumes');
            
            const resumes = await response.json();
            
            const resumesList = document.getElementById('resumes-list');
            
            if (resumes.length === 0) {
                resumesList.innerHTML = '<p style="color: #999;">No resumes uploaded yet.</p>';
                return;
            }
            
            resumesList.innerHTML = '<table><thead><tr><th>Version</th><th>Uploaded</th><th>Actions</th></tr></thead><tbody>' +
                resumes.map(resume => `
                    <tr id="resume-row-${resume.id}">
                        <td>${resume.version_label}</td>
                        <td>${new Date(resume.uploaded_at).toLocaleString()}</td>
                        <td>
                            <a href="/resumes/${resume.id}" class="btn" style="padding: 0.25rem 0.75rem; font-size: 0.9rem; line-height: 1.5; vertical-align: middle;">View Details</a>
                            <button onclick="deleteResume('${resume.id}')" class="btn btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.9rem; margin-left: 0.5rem; line-height: 1.5; vertical-align: middle;">Delete</button>
                        </td>
                    </tr>
                `).join('') +
                '</tbody></table>';
        } catch (error) {
            console.error('Error loading resumes:', error);
        }
    }
    
    async function loadProgress() {
        try {
            const response = await fetch(`${API_BASE}/jobs/${jobId}/progress`, {
                headers: getAuthHeaders()
            });
            
            if (!response.ok) throw new Error('Failed to load progress');
            
            const progress = await response.json();
            
            const progressChart = document.getElementById('progress-chart');
            
            if (progress.versions.length === 0) {
                progressChart.innerHTML = '<p style="color: #999;">No progress data yet.</p>';
                return;
            }
            
            progressChart.innerHTML = '<table><thead><tr><th>Version</th><th>Date</th><th>Overall Score</th></tr></thead><tbody>' +
                progress.versions.map(entry => {
                    const scoreClass = entry.overall_score >= 4 ? '' : entry.overall_score >= 3 ? 'medium' : 'low';
                    return `
                        <tr>
                            <td>${entry.version_label}</td>
                            <td>${new Date(entry.uploaded_at).toLocaleDateString()}</td>
                            <td><span class="score ${scoreClass}">${entry.overall_score.toFixed(2)}</span> / 5.00</td>
                        </tr>
                    `;
                }).join('') +
                '</tbody></table>';
        } catch (error) {
            console.error('Error loading progress:', error);
        }
    }
    
    function showUploadModal() {
        document.getElementById('upload-modal').style.display = 'block';
    }
    
    function hideUploadModal() {
        document.getElementById('upload-modal').style.display = 'none';
        document.getElementById('upload-form').reset();
    }
    
    async function uploadResume(event) {
        event.preventDefault();
        
        const btn = document.getElementById('upload-resume-btn');
        btn.classList.add('loading');
        btn.innerHTML = 'Uploading<span class="spinner"></span>';
        
        const versionLabel = document.getElementById('version-label').value;
        const fileInput = document.getElementById('resume-file');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select a file');
            btn.classList.remove('loading');
            btn.innerHTML = 'Upload';
            return;
        }
        
        const formData = new FormData();
        formData.append('version_label', versionLabel);
        formData.append('file', file);
        
        try {
            const response = await fetch(`${API_BASE}/jobs/${jobId}/resumes`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: formData
            });
            
            if (!response.ok) throw new Error('Failed to upload resume');
            
            const resume = await response.json();
            
            // Hide modal before navigation
            hideUploadModal();
            
            // Show analyzing message
            btn.innerHTML = 'Analyzing<span class="spinner"></span>';
            
            // Brief delay to show the analyzing message, then navigate
            setTimeout(() => {
                window.location.href = `/resumes/${resume.id}`;
            }, 500);
        } catch (error) {
            console.error('Error uploading resume:', error);
            btn.classList.remove('loading');
            btn.innerHTML = 'Upload';
            alert('Failed to upload resume. Please try again.');
        }
    }
    
    async function deleteCurrentJob() {
        if (!confirm('Are you sure you want to delete this job? This will also delete all associated resumes and evaluations.')) {
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE}/jobs/${jobId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete job');
            }
            
            // Redirect to dashboard
            window.location.href = '/dashboard';
        } catch (error) {
            console.error('Error deleting job:', error);
            alert('Failed to delete job. Please try again.');
        }
    }
    
    async function deleteResume(resumeId) {
        if (!confirm('Are you sure you want to delete this resume version?')) {
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE}/resumes/${resumeId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete resume');
            }
            
            // Remove row from table
            const row = document.getElementById(`resume-row-${resumeId}`);
            if (row) {
                row.remove();
            }
            
            // Check if no resumes left
            const tbody = document.querySelector('#resumes-list tbody');
            if (tbody && tbody.children.length === 0) {
                document.getElementById('resumes-list').innerHTML = '<p style="color: #999;">No resumes uploaded yet.</p>';
            }
            
            // Reload progress chart
            loadProgress();
        } catch (error) {
            console.error('Error deleting resume:', error);
            alert('Failed to delete resume. Please try again.');
        }
    }
    
    // Load all data
    loadJobDetails();
    loadRubric();
    loadResumes();
    loadProgress();
</script>
{% endblock %}
